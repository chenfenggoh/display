<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src 'self' https://accounts.spotify.com https://api.spotify.com https://api.data.gov.sg https://arrivelah2.busrouter.sg https://api.openweathermap.org; img-src 'self' data: blob: https://*.scdn.co https://*.spotifycdn.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;" />
  <title>NTU Smart Display</title>
  <style>
    /* Fallback font stack while Google Fonts loads (or on file://) */
    :root {
      --font-display: 'DM Serif Display', 'Georgia', serif;
      --font-mono:    'IBM Plex Mono', 'Courier New', monospace;
      --font-body:    'Space Grotesk', 'Segoe UI', sans-serif;
    }
  </style>
  <script>
    // Load Google Fonts only when online (not on file://)
    if (window.location.protocol !== 'file:') {
      const l = document.createElement('link');
      l.rel  = 'stylesheet';
      l.href = 'https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=IBM+Plex+Mono:wght@300;400;500&family=Space+Grotesk:wght@300;400;500&display=swap';
      document.head.appendChild(l);
    }
  </script>
  <style>
    :root {
      --bg:        #0a0e14;
      --surface:   #111722;
      --border:    #1e2a3a;
      --accent:    #00e5ff;
      --accent2:   #ff6b35;
      --accent3:   #a8ff78;
      --text:      #e8f4f8;
      --muted:     #5a7a8a;
      --danger:    #ff4757;
      --warning:   #ffd700;
      --seats-ok:  #00e5a0;
      --seats-sda: #ffd700;
      --seats-lsd: #ff6b35;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Animated background grid */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0,229,255,.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,229,255,.03) 1px, transparent 1px);
      background-size: 48px 48px;
      pointer-events: none;
      z-index: 0;
    }

    /* Corner glow orbs */
    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(100px);
      pointer-events: none;
      z-index: 0;
      animation: pulse 8s ease-in-out infinite;
    }
    .orb-1 { width: 400px; height: 400px; background: rgba(0,229,255,.06); top: -100px; left: -100px; }
    .orb-2 { width: 300px; height: 300px; background: rgba(255,107,53,.06); bottom: -80px; right: -80px; animation-delay: -4s; }
    @keyframes pulse { 0%,100%{opacity:.5} 50%{opacity:1} }

    /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
    .app {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-rows: auto 1fr;
      grid-template-columns: 1fr;
      min-height: 100vh;
      padding: 20px;
      gap: 16px;
    }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 20px 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: scan 4s linear infinite;
    }
    @keyframes scan { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }

    .date-block .day {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      font-weight: 300;
      color: var(--muted);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }
    .date-block .date {
      font-family: var(--font-display);
      font-size: 1.4rem;
      color: var(--text);
      margin-top: 2px;
    }

    .clock-center {
      text-align: center;
    }
    .clock-center .time {
      font-family: var(--font-mono);
      font-size: clamp(3rem, 8vw, 6rem);
      font-weight: 400;
      color: var(--accent);
      letter-spacing: -0.02em;
      line-height: 1;
      text-shadow: 0 0 40px rgba(0,229,255,.3);
    }
    .clock-center .seconds {
      font-family: var(--font-mono);
      font-size: 1.4rem;
      font-weight: 300;
      color: var(--muted);
    }

    .location-block {
      text-align: right;
    }
    .location-block .label {
      font-size: 0.65rem;
      font-weight: 300;
      color: var(--muted);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }
    .location-block .campus {
      font-family: var(--font-display);
      font-size: 1.2rem;
      color: var(--accent2);
    }

    /* ‚îÄ‚îÄ‚îÄ MAIN GRID ‚îÄ‚îÄ‚îÄ */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 2fr;
      grid-template-rows: auto auto;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 1100px) {
      .main-grid { grid-template-columns: 1fr 1fr 2fr; }
      .public-bus-section { grid-column: 1 / -1; }
    }
    @media (max-width: 750px) {
      .main-grid { grid-template-columns: 1fr 1fr; }
      .bus-section { grid-column: 1 / -1; }
      .public-bus-section { grid-column: 1 / -1; }
    }
    @media (max-width: 500px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    /* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      font-weight: 400;
      color: var(--muted);
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title::before {
      content: '';
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
      animation: blink 2s ease-in-out infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }



    /* ‚îÄ‚îÄ‚îÄ MINI STATS CARD ‚îÄ‚îÄ‚îÄ */
    .stat-big {
      font-family: var(--font-mono);
      font-size: 2.2rem;
      font-weight: 400;
      color: var(--accent3);
      line-height: 1;
    }
    .stat-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ‚îÄ WEATHER ‚îÄ‚îÄ‚îÄ */
    .weather-main {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 12px;
    }
    .weather-icon { font-size: 3rem; line-height: 1; }
    .weather-temp {
      font-family: var(--font-display);
      font-size: 2.6rem;
      color: var(--warning);
      line-height: 1;
    }
    .weather-unit { font-size: 1.1rem; color: var(--muted); }
    .weather-desc { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
    .weather-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    .weather-detail {
      background: rgba(0,229,255,.04);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 6px 9px;
    }
    .weather-detail .wlabel {
      font-family: var(--font-mono);
      font-size: 0.5rem;
      color: var(--muted);
      letter-spacing: .1em;
      text-transform: uppercase;
    }
    .weather-detail .wval {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text);
      margin-top: 1px;
    }

    /* ‚îÄ‚îÄ‚îÄ PUBLIC BUS TABLE ‚îÄ‚îÄ‚îÄ */
    .public-bus-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 14px;
    }
    .pb-stop-block {
      background: rgba(0,229,255,.02);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
    }
    .pb-stop-name {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--accent);
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pb-services {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .pb-svc {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 5px 9px;
      min-width: 80px;
    }
    .pb-svc-no {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text);
      min-width: 28px;
    }
    .pb-times {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .pb-time {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--muted);
    }
    .pb-time.next { color: var(--accent); font-weight: 500; }
    .pb-time.arriving { color: var(--accent3); font-weight: 600; }
    .pb-load-full  { color: var(--danger); }
    .pb-load-stand { color: var(--warning); }
    .pb-load-seat  { color: var(--seats-ok); }

    /* ‚îÄ‚îÄ‚îÄ BUS SECTION (NTU shuttle, col 4 row 1) ‚îÄ‚îÄ‚îÄ */
    .bus-section {
      grid-column: 4;
      grid-row: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ‚îÄ‚îÄ‚îÄ PUBLIC BUS SECTION (full-width row 2) ‚îÄ‚îÄ‚îÄ */
    .public-bus-section {
      grid-column: 1 / -1;
      grid-row: 2;
    }

    .bus-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .bus-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .bus-panel-title {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      color: var(--muted);
      letter-spacing: .2em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .bus-panel-title::before {
      content: '';
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--accent2);
      box-shadow: 0 0 8px var(--accent2);
      animation: blink 2s ease-in-out infinite;
    }

    .last-updated {
      font-family: var(--font-mono);
      font-size: 0.55rem;
      color: var(--muted);
    }

    .stop-name {
      font-family: var(--font-display);
      font-size: 1.1rem;
      color: var(--text);
      margin-bottom: 12px;
    }
    .stop-code {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--accent);
      background: rgba(0,229,255,.08);
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .bus-row {
      display: grid;
      grid-template-columns: 60px 1fr 1fr 1fr;
      gap: 6px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 6px;
      border: 1px solid transparent;
      transition: all .3s ease;
      background: rgba(255,255,255,.02);
    }
    .bus-row:hover { background: rgba(0,229,255,.04); border-color: var(--border); }

    .bus-num {
      font-family: var(--font-mono);
      font-weight: 500;
      font-size: 1rem;
      color: var(--text);
      background: var(--border);
      padding: 4px 8px;
      border-radius: 6px;
      text-align: center;
    }

    .bus-time {
      text-align: center;
    }
    .bus-time .mins {
      font-family: var(--font-mono);
      font-weight: 500;
      font-size: 1.1rem;
      display: block;
    }
    .bus-time .mins.arriving { color: var(--accent); text-shadow: 0 0 12px var(--accent); }
    .bus-time .mins.soon     { color: var(--accent3); }
    .bus-time .mins.later    { color: var(--text); }
    .bus-time .mins.na       { color: var(--muted); font-size: .8rem; }
    .bus-time .min-label {
      font-family: var(--font-mono);
      font-size: 0.5rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .1em;
    }

    .bus-load {
      text-align: center;
    }
    .load-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      margin-right: 4px;
    }
    .load-sea .load-dot { background: var(--seats-ok); box-shadow: 0 0 6px var(--seats-ok); }
    .load-sda .load-dot { background: var(--seats-sda); box-shadow: 0 0 6px var(--seats-sda); }
    .load-lsd .load-dot { background: var(--seats-lsd); box-shadow: 0 0 6px var(--seats-lsd); }
    .load-label {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .05em;
      vertical-align: middle;
    }

    .bus-type {
      text-align: right;
    }
    .type-badge {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .type-badge.dd  { color: var(--accent2); background: rgba(255,107,53,.1); }
    .type-badge.bd  { color: var(--accent3); background: rgba(168,255,120,.1); }
    .type-badge.wab { color: var(--accent); }

    /* divider */
    .bus-divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    /* NTU bus section */
    .ntu-route-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 6px;
    }
    .ntu-route-badge.clb { background: rgba(30,100,255,.2); border: 1px solid rgba(30,100,255,.4); color: #6ab0ff; }
    .ntu-route-badge.clr { background: rgba(255,60,60,.2); border: 1px solid rgba(255,60,60,.4); color: #ff8080; }
    .ntu-route-badge.cr  { background: rgba(0,200,120,.2); border: 1px solid rgba(0,200,120,.4); color: var(--accent3); }

    .ntu-arrival-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,.02);
      border: 1px solid transparent;
      margin-bottom: 6px;
    }

    .ntu-route-info { display: flex; align-items: center; gap: 10px; }
    .ntu-route-name {
      font-family: var(--font-mono);
      font-size: 0.85rem;
      color: var(--text);
    }

    .ntu-times { display: flex; gap: 12px; }
    .ntu-time-chip {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      padding: 4px 10px;
      border-radius: 8px;
      background: var(--border);
      color: var(--text);
    }
    .ntu-time-chip.next { color: var(--accent); background: rgba(0,229,255,.1); border: 1px solid rgba(0,229,255,.2); }
    .ntu-time-chip.soon { color: var(--accent3); background: rgba(168,255,120,.08); }

    .occupancy-bar {
      height: 3px;
      border-radius: 2px;
      background: var(--border);
      margin-top: 4px;
      overflow: hidden;
    }
    .occupancy-fill {
      height: 100%;
      border-radius: 2px;
      transition: width .5s ease;
    }

    /* ‚îÄ‚îÄ‚îÄ SPOTIFY NOW PLAYING ‚îÄ‚îÄ‚îÄ */
    .spotify-card {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .sp-idle {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 20px 0;
    }
    .sp-idle-icon {
      font-size: 2.5rem;
      opacity: .3;
    }
    .sp-idle-text {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
    }
    .sp-connect-btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      background: #1db954;
      color: #000;
      border: none;
      border-radius: 20px;
      padding: 8px 18px;
      font-family: var(--font-body);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: .02em;
      transition: all .2s;
    }
    .sp-connect-btn:hover { background: #1ed760; transform: scale(1.03); }
    .sp-connect-btn:disabled { background: #555; color: #888; cursor: not-allowed; transform: none; }
    .sp-disconnect-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 6px;
      padding: 4px 10px;
      font-family: var(--font-mono);
      font-size: 0.6rem;
      cursor: pointer;
      transition: all .15s;
      letter-spacing: .05em;
    }
    .sp-disconnect-btn:hover { border-color: var(--danger); color: var(--danger); }
    .sp-now-playing {
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }
    .sp-album-art {
      width: 76px;
      height: 76px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      box-shadow: 0 4px 20px rgba(0,0,0,.5);
      background: var(--border);
    }
    .sp-album-art.spinning {
      animation: sp-spin 8s linear infinite;
    }
    @keyframes sp-spin {
      from { border-radius: 50%; }
      to   { border-radius: 50%; transform: rotate(360deg); }
    }
    .sp-track-info {
      flex: 1;
      min-width: 0;
    }
    .sp-track-name {
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
      margin-bottom: 3px;
    }
    .sp-artist {
      font-size: 0.75rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .sp-album {
      font-size: 0.65rem;
      color: var(--muted);
      opacity: .6;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sp-progress-wrap {
      margin-top: 10px;
    }
    .sp-progress-bar {
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .sp-progress-fill {
      height: 100%;
      background: #1db954;
      border-radius: 2px;
      transition: width .5s linear;
    }
    .sp-times {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-mono);
      font-size: 0.55rem;
      color: var(--muted);
    }
    .sp-state-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
    }
    .sp-playing-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: var(--font-mono);
      font-size: 0.55rem;
      color: #1db954;
      letter-spacing: .1em;
    }
    .sp-playing-badge::before {
      content: '';
      width: 6px; height: 6px;
      background: #1db954;
      border-radius: 50%;
      animation: blink 1.5s ease-in-out infinite;
    }
    .sp-paused-badge {
      font-family: var(--font-mono);
      font-size: 0.55rem;
      color: var(--muted);
      letter-spacing: .1em;
    }
    .sp-nothing {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
      padding: 16px 0;
    }

    /* Config panel */
    .config-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      letter-spacing: .1em;
      transition: all .2s;
    }
    .config-btn:hover { color: var(--accent); border-color: var(--accent); }

    .config-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }
    .config-modal.open { display: flex; }

    .config-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      width: min(680px, 96vw);
      max-height: 94vh;
      overflow-y: auto;
    }

    /* ‚îÄ‚îÄ Tab nav ‚îÄ‚îÄ */
    .cfg-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--bg);
      padding: 4px;
      border-radius: 10px;
    }
    .cfg-tab {
      flex: 1;
      padding: 8px 10px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-family: var(--font-mono);
      font-size: 0.65rem;
      letter-spacing: .1em;
      text-transform: uppercase;
      border-radius: 7px;
      cursor: pointer;
      transition: all .2s;
    }
    .cfg-tab.active { background: var(--surface); color: var(--accent); border: 1px solid var(--border); }
    .cfg-pane { display: none; }
    .cfg-pane.active { display: block; }

    /* ‚îÄ‚îÄ Stop picker ‚îÄ‚îÄ */
    .stop-search-wrap {
      position: relative;
      margin-bottom: 12px;
    }
    .stop-search {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px 10px 36px;
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.85rem;
      outline: none;
      transition: border-color .2s;
    }
    .stop-search:focus { border-color: var(--accent); }
    .stop-search-icon {
      position: absolute;
      left: 12px; top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 0.85rem;
      pointer-events: none;
    }

    .stop-area-label {
      font-family: var(--font-mono);
      font-size: 0.55rem;
      letter-spacing: .15em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 10px 0 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 6px;
      margin-top: 8px;
    }
    .stop-area-label:first-child { margin-top: 0; }

    .stop-list {
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px;
      background: var(--bg);
      margin-bottom: 14px;
    }
    .stop-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 10px;
      border-radius: 7px;
      cursor: pointer;
      transition: background .15s;
      border: 1px solid transparent;
    }
    .stop-item:hover { background: rgba(0,229,255,.05); }
    .stop-item.selected {
      background: rgba(0,229,255,.08);
      border-color: rgba(0,229,255,.25);
    }
    .stop-item .si-code {
      font-family: var(--font-mono);
      font-size: 0.68rem;
      color: var(--accent);
      background: rgba(0,229,255,.08);
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
      min-width: 46px;
      text-align: center;
      flex-shrink: 0;
    }
    .stop-item .si-name {
      font-size: 0.82rem;
      color: var(--text);
      flex: 1;
    }
    .stop-item .si-routes {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      color: var(--muted);
      text-align: right;
    }
    .stop-item .si-check {
      width: 16px; height: 16px;
      border: 1.5px solid var(--border);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      font-size: 0.65rem;
      transition: all .15s;
    }
    .stop-item.selected .si-check {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
    }

    .selected-stops-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.78rem;
      min-height: 38px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 4px;
    }
    .sel-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: rgba(0,229,255,.1);
      border: 1px solid rgba(0,229,255,.25);
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: 6px;
    }
    .sel-chip button {
      background: none; border: none; color: var(--accent);
      cursor: pointer; font-size: 0.7rem; padding: 0; opacity:.7;
    }
    .sel-chip button:hover { opacity: 1; }
    .sel-hint { font-size: 0.65rem; color: var(--muted); margin-top: 2px; }

    /* NTU route picker checkboxes */
    .route-toggles {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }
    .route-toggle { display: none; }
    .route-toggle-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-family: var(--font-mono);
      font-size: 0.72rem;
      border: 1px solid var(--border);
      color: var(--muted);
      background: var(--bg);
      transition: all .2s;
      user-select: none;
    }
    #rt-clb:checked + .route-toggle-label { background: rgba(30,100,255,.15); border-color: rgba(30,100,255,.4); color: #6ab0ff; }
    #rt-clr:checked + .route-toggle-label { background: rgba(255,60,60,.15);  border-color: rgba(255,60,60,.4);  color: #ff8080; }
    #rt-cr:checked  + .route-toggle-label { background: rgba(0,200,120,.15);  border-color: rgba(0,200,120,.4);  color: var(--accent3); }
    #rt-cwr:checked + .route-toggle-label { background: rgba(255,165,0,.15);  border-color: rgba(255,165,0,.4);  color: #ffb347; }
    .config-box h2 {
      font-family: var(--font-display);
      font-size: 1.6rem;
      margin-bottom: 6px;
    }
    .config-box p.sub {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 24px;
    }

    .field { margin-bottom: 16px; }
    .field label {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--muted);
      letter-spacing: .12em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .field input, .field select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 8px;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      outline: none;
      transition: border-color .2s;
    }
    .field input:focus, .field select:focus { border-color: var(--accent); }
    .field small { font-size: 0.65rem; color: var(--muted); margin-top: 4px; display: block; }

    .btn-row { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all .2s;
    }
    .btn-cancel { background: transparent; color: var(--muted); }
    .btn-cancel:hover { color: var(--text); }
    .btn-save { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 500; }
    .btn-save:hover { opacity: .85; }

    .loading-text {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
      padding: 20px;
      animation: fade 1.5s ease-in-out infinite alternate;
    }
    @keyframes fade { from{opacity:.3} to{opacity:1} }

    .error-msg {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--danger);
      padding: 10px 14px;
      background: rgba(255,71,87,.08);
      border: 1px solid rgba(255,71,87,.2);
      border-radius: 8px;
    }

    .refresh-btn {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      color: var(--muted);
      background: transparent;
      border: 1px solid var(--border);
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all .2s;
      letter-spacing: .08em;
    }
    .refresh-btn:hover { color: var(--accent); border-color: var(--accent); }

    /* NTU notice */
    .ntu-notice {
      background: rgba(255,107,53,.06);
      border: 1px solid rgba(255,107,53,.2);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 0.72rem;
      color: var(--muted);
      line-height: 1.5;
    }
    .ntu-notice strong { color: var(--accent2); }

    /* Status indicator */
    .status-dot {
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-live { background: var(--accent3); box-shadow: 0 0 6px var(--accent3); animation: blink 1.5s infinite; }
    .status-offline { background: var(--danger); }

    /* Humidity card */
    .hum-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .hum-row:last-child { border-bottom: none; }
    .hum-row .hlabel { font-size: 0.75rem; color: var(--muted); }
    .hum-row .hval   { font-family: var(--font-mono); font-size: 0.85rem; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  </style>
</head>
<body>

<div class="orb orb-1"></div>
<div class="orb orb-2"></div>

<div class="app">

  <!-- HEADER: Date + Clock + Location -->
  <header>
    <div class="date-block">
      <div class="day" id="dayName">‚Äî</div>
      <div class="date" id="dateString">‚Äî</div>
    </div>
    <div class="clock-center">
      <div class="time" id="clockHM">--:--</div>
      <div class="seconds" id="clockSec">--</div>
    </div>
    <div class="location-block">
      <div class="label">Campus</div>
      <div class="campus">NTU ¬∑ Jurong West SG</div>
    </div>
  </header>

  <!-- MAIN CONTENT GRID -->
  <div class="main-grid">

    <!-- TODAY AT NTU (col 1, row 1) -->
    <div class="card" style="grid-column:1; grid-row:1">
      <div class="card-title">Today at NTU</div>
      <div id="todayCard">
        <div class="hum-row">
          <span class="hlabel">‚ö° Semester</span>
          <span class="hval" id="semLabel">‚Äî</span>
        </div>
        <div class="hum-row">
          <span class="hlabel">üìÖ Week</span>
          <span class="hval" id="weekLabel">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- WEATHER (col 2, row 1) -->
    <div class="card" style="grid-column:2; grid-row:1">
      <div class="card-title">Weather</div>
      <div id="weatherContent">
        <div class="loading-text">Fetching weather‚Ä¶</div>
      </div>
    </div>

    <!-- SPOTIFY NOW PLAYING (col 3, row 1) -->
    <div class="card" style="grid-column:3; grid-row:1">
      <div class="card-title" style="justify-content:space-between">
        <span>Now Playing</span>
        <span id="spHeaderBtn"></span>
      </div>
      <div class="spotify-card" id="spotifyCard">
        <div class="sp-idle">
          <div class="sp-idle-icon">üéµ</div>
          <div class="sp-idle-text">Connect Spotify to see what's playing</div>
          <button class="sp-connect-btn" id="spConnectBtn" onclick="spotifyLogin()">
            ‚ô´ Connect Spotify
          </button>
        </div>
      </div>
    </div>

    <!-- NTU SHUTTLE (col 4, row 1) -->
    <div class="bus-section">
      <div class="bus-panel">
        <div class="bus-panel-header">
          <div class="bus-panel-title">
            <span class="status-dot status-offline" id="ntuStatusDot"></span>
            NTU Omnibus ¬∑ Campus Shuttle
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="last-updated" id="ntuLastUpdated">‚Äî</div>
            <button class="refresh-btn" onclick="fetchNtuBus()">‚Üª Refresh</button>
          </div>
        </div>
        <div id="ntuBusContent">
          <div class="loading-text">Initialising‚Ä¶</div>
        </div>
      </div>
    </div>

    <!-- PUBLIC BUS (row 2, full width) -->
    <div class="public-bus-section">
      <div class="bus-panel">
        <div class="bus-panel-header">
          <div class="bus-panel-title">
            <span class="status-dot status-offline" id="ltaStatusDot"></span>
            Public Bus ¬∑ LTA Live
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="last-updated" id="ltaLastUpdated">‚Äî</div>
            <button class="refresh-btn" onclick="fetchLtaBus()">‚Üª Refresh</button>
          </div>
        </div>
        <div id="ltaBusContent">
          <div class="loading-text">Select bus stops in ‚öô Settings ‚Üí Bus Stops</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- CONFIG BUTTON -->
<button class="config-btn" onclick="openConfig()">‚öô Settings</button>

<!-- CONFIG MODAL -->
<div class="config-modal" id="configModal">
  <div class="config-box">
    <h2>Display Settings</h2>
    <p class="sub">Settings are stored locally on this device only.</p>

    <!-- Tab nav -->
    <div class="cfg-tabs">
      <button class="cfg-tab active" onclick="switchTab('bus')">üöå Bus Stops</button>
      <button class="cfg-tab" onclick="switchTab('ntu')">üéì NTU Shuttle</button>
      <button class="cfg-tab" onclick="switchTab('spotify')">üéµ Spotify</button>
      <button class="cfg-tab" onclick="switchTab('api')">üîë API Keys</button>
      <button class="cfg-tab" onclick="switchTab('display')">‚öô Display</button>
    </div>

    <!-- ‚îÄ‚îÄ TAB: BUS STOPS ‚îÄ‚îÄ -->
    <div class="cfg-pane active" id="pane-bus">
      <div class="field" style="margin-bottom:8px">
        <label>Your selected stops (up to 3)</label>
        <div class="selected-stops-preview" id="selectedStopsPreview">
          <span style="color:var(--muted);font-size:.75rem">No stops selected ‚Äî pick from the list below</span>
        </div>
        <div class="sel-hint">Tap a stop to add. Tap again to remove. Up to 3 stops.</div>
      </div>
      <div class="stop-search-wrap">
        <span class="stop-search-icon">üîç</span>
        <input class="stop-search" id="busStopSearchInput" type="text"
          placeholder="Search by name, code, or bus number‚Ä¶"
          oninput="filterBusStops(this.value)" autocomplete="off" />
      </div>
      <div class="stop-list" id="busStopListContainer"></div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: NTU SHUTTLE ‚îÄ‚îÄ -->
    <div class="cfg-pane active" id="pane-ntu">
      <div class="field">
        <label>NTU shuttle routes to show</label>
        <div class="route-toggles">
          <input type="checkbox" class="route-toggle" id="rt-clb" />
          <label class="route-toggle-label" for="rt-clb">üîµ Campus Loop ‚Äì Blue</label>

          <input type="checkbox" class="route-toggle" id="rt-clr" />
          <label class="route-toggle-label" for="rt-clr">üî¥ Campus Loop ‚Äì Red</label>

          <input type="checkbox" class="route-toggle" id="rt-cr" />
          <label class="route-toggle-label" for="rt-cr">üü¢ Campus Rider (Pioneer MRT)</label>

          <input type="checkbox" class="route-toggle" id="rt-cwr" />
          <label class="route-toggle-label" for="rt-cwr">üü† Campus Weekend Rider</label>
        </div>
        <small>CL-B &amp; CL-R loop the campus (~10 min interval). CR goes to Pioneer MRT (~15 min). CWR operates weekends/PH only.</small>
      </div>

      <div class="field">
        <label>Your usual NTU pickup stop</label>
        <div class="stop-search-wrap">
          <span class="stop-search-icon">üîç</span>
          <input class="stop-search" id="stopSearchInput" type="text"
            placeholder="Search stop name or route‚Ä¶"
            oninput="filterStops(this.value)" autocomplete="off" />
        </div>
        <div class="stop-list" id="stopListContainer" style="max-height:200px">
          <!-- Populated by JS -->
        </div>
        <div id="selectedStopDisplay" style="margin-top:8px;font-size:.75rem;color:var(--accent)"></div>
        <small style="display:block;margin-top:4px">This label shows next to the shuttle panel.</small>
      </div>

      <div class="ntu-notice" style="margin-top:16px">
        <strong>‚ÑπÔ∏è Note:</strong> NTU Omnibus uses a closed API ‚Äî no public endpoint exists.
        Times shown are schedule-based estimates (¬±2‚Äì3 min). Use the official
        <strong>NTU Omnibus app</strong> for real-time GPS tracking.
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: SPOTIFY ‚îÄ‚îÄ -->
    <div class="cfg-pane" id="pane-spotify">
      <div id="spSettingsStatus" style="margin-bottom:14px"></div>

      <div class="field">
        <label>Spotify Client ID</label>
        <input type="text" id="cfgSpClientId" placeholder="e.g. 1a2b3c4d5e6f7890abcdef1234567890" autocomplete="off" />
        <small>
          1. Go to <strong>developer.spotify.com/dashboard</strong> ‚Üí Create app<br>
          2. Under <strong>Redirect URIs</strong>, add exactly:<br>
          <code id="spRedirectUriDisplay" style="color:var(--accent);font-size:.75rem;display:block;margin:5px 0 4px;padding:4px 6px;background:rgba(0,229,255,.06);border-radius:4px;word-break:break-all;user-select:all">https://chenfenggoh.github.io/display/</code>
          3. Paste your Client ID above ‚Üí Save ‚Üí Connect
        </small>
      </div>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
        <button class="sp-connect-btn" id="spSettingsConnectBtn" onclick="spotifyLoginFromSettings()">‚ô´ Connect Spotify</button>
        <button class="sp-disconnect-btn" id="spSettingsDisconnectBtn" onclick="spotifyLogout()" style="display:none">Disconnect</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: API KEYS ‚îÄ‚îÄ -->
    <div class="cfg-pane" id="pane-api">
      <div class="ntu-notice" style="margin-bottom:14px;background:rgba(0,229,255,.04);border-color:rgba(0,229,255,.2)">
        <strong style="color:var(--accent)">‚úÖ No API keys required by default.</strong><br>
        Bus data uses <strong>arrivelah (busrouter.sg)</strong> ‚Äî free, open, CORS-friendly.<br>
        Weather uses <strong>NEA data.gov.sg</strong> ‚Äî Singapore official open data, no key needed.
      </div>
      <div class="field">
        <label>LTA DataMall API Key <span style="color:var(--muted)">(optional fallback)</span></label>
        <input type="text" id="cfgLtaKey" placeholder="e.g. AbCd1234efGh5678==" />
        <small>Used only if arrivelah is unavailable. Free from <strong>datamall.lta.gov.sg</strong></small>
      </div>
      <div class="field">
        <label>OpenWeatherMap API Key <span style="color:var(--muted)">(optional fallback)</span></label>
        <input type="text" id="cfgWeatherKey" placeholder="e.g. 1a2b3c4d5e6f7890abcd‚Ä¶" />
        <small>Used only if NEA data.gov.sg is unavailable. Free from <strong>openweathermap.org</strong></small>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: DISPLAY ‚îÄ‚îÄ -->
    <div class="cfg-pane" id="pane-display">
      <div class="field">
        <label>Refresh Interval (seconds)</label>
        <input type="number" id="cfgRefresh" placeholder="30" min="15" max="300" />
        <small>How often to recalculate shuttle schedule estimates. Minimum 15s.</small>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-cancel" onclick="closeConfig()">Cancel</button>
      <button class="btn btn-save" onclick="saveConfig()">Save &amp; Apply</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// XHR FETCH HELPER
// Replaces fetch() for file:// compatibility.
// Android WebView blocks fetch() from file:// but
// allows XMLHttpRequest. This wrapper mimics fetch's
// Promise API so the rest of the code stays clean.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function xhrFetch(url, options = {}) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open(options.method || 'GET', url, true);

    // Set request headers
    if (options.headers) {
      Object.entries(options.headers).forEach(([k, v]) => {
        xhr.setRequestHeader(k, v);
      });
    }

    xhr.timeout = 10000; // 10 second timeout

    xhr.onload = () => {
      resolve({
        ok: xhr.status >= 200 && xhr.status < 300,
        status: xhr.status,
        json: () => Promise.resolve(JSON.parse(xhr.responseText)),
        text: () => Promise.resolve(xhr.responseText),
      });
    };
    xhr.onerror   = () => reject(new Error(`Network error fetching ${url}`));
    xhr.ontimeout = () => reject(new Error(`Timeout fetching ${url}`));

    xhr.send(options.body || null);
  });
}

// Override global fetch with xhrFetch on file:// (Android WebView / local file)
if (window.location.protocol === 'file:') {
  window.fetch = xhrFetch;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NTU SHUTTLE STOP DATABASE
// Only stops served by NTU Omnibus routes
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NTU_STOPS = [
  // ‚îÄ‚îÄ Campus Loop ‚Äì Blue (CL-B) & Red (CL-R) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Hall 1 / Opp Hall 16',              routes: 'CL-B' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp Hall 2 (Lien Ying Chow)',       routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp Hall 4 (Nanyang Dr)',            routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp Hall 8 / Nanyang Heights',       routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Hall 9 / Opp Hall 8',               routes: 'CL-B' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp Hall 10 & 11',                  routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Nanyang Crescent Hall (Hall 10/11)', routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp Hall 14 & 15',                  routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp Hall 3 & 16 (Nanyang Walk)',     routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'NIE Block 2 / Opp Hall 3 & 16',     routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Lee Wee Nam Library',               routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp SPMS / South Spine',            routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Admin Cluster / The Hive',          routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp WKWSCI / North Spine',          routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Gaia / Academic Building South',    routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp Yunnan Garden',                 routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Nanyang Dr ‚Äì Hall 2',               routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Nanyang Dr ‚Äì Block 41',             routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Opp School of CEE (Nanyang Dr)',    routes: 'CL-B, CL-R' },
  { area: 'Campus Loops (CL-B & CL-R)', name: 'Hall 6 / Lien Ying Chow Dr',        routes: 'CL-B' },
  // ‚îÄ‚îÄ Campus Rider (CR) & Campus Weekend Rider (CWR) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { area: 'Campus Rider (CR & CWR)',    name: 'Pioneer Hall / Nanyang Terrace',    routes: 'CR, CL-R' },
  { area: 'Campus Rider (CR & CWR)',    name: 'Pioneer MRT Exit B',                routes: 'CR, CWR' },
];

const UNIQUE_STOPS = NTU_STOPS;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PUBLIC BUS STOP DATABASE (NTU area stops)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PUBLIC_BUS_STOPS = [
  { area: 'On Campus ‚Äì NTU',    code: '27219', name: 'NIE Block 2',                   routes: '179, CL-B, CL-R' },
  { area: 'On Campus ‚Äì NTU',    code: '27211', name: 'Lee Wee Nam Library',           routes: '179, 179A, CL-B, CL-R' },
  { area: 'On Campus ‚Äì NTU',    code: '27201', name: 'Opp Hall 8 (Nanyang Heights)',  routes: '179, CL-B, CL-R' },
  { area: 'On Campus ‚Äì NTU',    code: '63725', name: 'Opp Hall 2 (Lien Ying Chow)',   routes: '179, 199, CL-B, CL-R' },
  { area: 'On Campus ‚Äì NTU',    code: '63709', name: 'Opp SPMS / South Spine',        routes: '179, 199, CL-B, CL-R' },
  { area: 'On Campus ‚Äì NTU',    code: '63721', name: 'Admin Cluster / The Hive',      routes: '179, 199, CL-B, CL-R' },
  { area: 'On Campus ‚Äì NTU',    code: '63723', name: 'Opp WKWSCI / North Spine',      routes: '179, CL-B, CL-R' },
  { area: 'On Campus ‚Äì NTU',    code: '63705', name: 'Gaia / Academic Building South',routes: '179, 199, CL-B, CL-R' },
  { area: 'On Campus ‚Äì NTU',    code: '63731', name: 'Opp Yunnan Garden',             routes: '179, 199, CL-B, CL-R' },
  { area: 'Halls & Residences', code: '27321', name: 'Hall 1 / Opp Hall 16',          routes: '179, 179B, CL-B' },
  { area: 'Halls & Residences', code: '63703', name: 'Opp Hall 10 & 11',             routes: '199, CL-B, CL-R' },
  { area: 'Halls & Residences', code: '63733', name: 'Opp Hall 14 & 15',             routes: '199, CL-B, CL-R' },
  { area: 'Halls & Residences', code: '27331', name: 'Pioneer Hall / Nanyang Terrace',routes: '179, CL-R, CR' },
  { area: 'Pioneer MRT (EW28)', code: '24481', name: 'Pioneer MRT Exit B (to NTU)',   routes: '179, CR, CWR' },
  { area: 'Pioneer MRT (EW28)', code: '24489', name: 'Opp Pioneer MRT / Exit A',      routes: '179, 99, 99A' },
  { area: 'Boon Lay (EW27)',    code: '22009', name: 'Boon Lay Bus Interchange (A)',  routes: '179, 179A, 199, 77' },
  { area: 'Boon Lay (EW27)',    code: '22099', name: 'Boon Lay Bus Interchange (B)',  routes: '179, 199, 98A, 243' },
  { area: 'Boon Lay (EW27)',    code: '22159', name: 'Opp Jurong Point',              routes: '77, 98, 98A, 179, 179A' },
];
const PUBLIC_BUS_MAP = {};
PUBLIC_BUS_STOPS.forEach(s => { PUBLIC_BUS_MAP[s.code] = s; });

let selectedStops = [];

function renderBusStopList(query = '') {
  const container = document.getElementById('busStopListContainer');
  if (!container) return;
  const q = query.toLowerCase().trim();
  const areas = {};
  PUBLIC_BUS_STOPS.forEach(stop => {
    if (q && !stop.name.toLowerCase().includes(q) &&
             !stop.code.includes(q) &&
             !stop.routes.toLowerCase().includes(q) &&
             !stop.area.toLowerCase().includes(q)) return;
    if (!areas[stop.area]) areas[stop.area] = [];
    areas[stop.area].push(stop);
  });
  let html = '';
  for (const [area, stops] of Object.entries(areas)) {
    html += `<div class="stop-area-label">${area}</div>`;
    stops.forEach(stop => {
      const sel = selectedStops.includes(stop.code);
      html += `<div class="stop-item ${sel ? 'selected' : ''}" onclick="toggleBusStop('${stop.code}')">
        <span class="si-code">${stop.code}</span>
        <span class="si-name">${stop.name}</span>
        <span class="si-routes">${stop.routes}</span>
        <span class="si-check">${sel ? '‚úì' : ''}</span>
      </div>`;
    });
  }
  if (!html) html = `<div style="padding:16px;text-align:center;color:var(--muted);font-size:.8rem">No stops found</div>`;
  container.innerHTML = html;
}

function filterBusStops(q) { renderBusStopList(q); }

function toggleBusStop(code) {
  const idx = selectedStops.indexOf(code);
  if (idx > -1) {
    selectedStops.splice(idx, 1);
  } else {
    if (selectedStops.length >= 3) {
      const prev = document.getElementById('selectedStopsPreview');
      if (prev) { prev.style.borderColor = 'var(--danger)'; setTimeout(() => prev.style.borderColor = '', 800); }
      return;
    }
    selectedStops.push(code);
  }
  renderSelectedChips();
  renderBusStopList(document.getElementById('busStopSearchInput')?.value || '');
}

function renderSelectedChips() {
  const preview = document.getElementById('selectedStopsPreview');
  if (!preview) return;
  if (selectedStops.length === 0) {
    preview.innerHTML = `<span style="color:var(--muted);font-size:.75rem">No stops selected ‚Äî pick from the list below</span>`;
    return;
  }
  preview.innerHTML = selectedStops.map(code => {
    const stop = PUBLIC_BUS_MAP[code];
    const label = stop ? `${code} ¬∑ ${stop.name.split('(')[0].trim()}` : code;
    return `<span class="sel-chip">${label}<button onclick="removeBusStop('${code}')" title="Remove">√ó</button></span>`;
  }).join('');
}

function removeBusStop(code) {
  selectedStops = selectedStops.filter(c => c !== code);
  renderSelectedChips();
  renderBusStopList(document.getElementById('busStopSearchInput')?.value || '');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_CONFIG = {
  ntuStop:         'Hall 1',
  ntuRoutes:       'CL-B,CL-R,CR',
  busStops:        [],
  ltaKey:          '',
  weatherKey:      '',
  refresh:         30,
  spotifyClientId: '',
};

let cfg = loadConfig();
let clockInterval   = null;
let refreshInterval = null;

function loadConfig() {
  try {
    const raw = localStorage.getItem('smartDisplayConfig');
    const parsed = raw ? JSON.parse(raw) : {};
    return { ...DEFAULT_CONFIG, ...parsed };
  } catch { return { ...DEFAULT_CONFIG }; }
}

// ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
function switchTab(name) {
  document.querySelectorAll('.cfg-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.cfg-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('pane-' + name).classList.add('active');
  document.querySelectorAll('.cfg-tab')[['bus','ntu','spotify','api','display'].indexOf(name)].classList.add('active');
}

// ‚îÄ‚îÄ Stop list rendering (single-select, pick your stop label) ‚îÄ‚îÄ
function renderStopList(query = '') {
  const container = document.getElementById('stopListContainer');
  const q = query.toLowerCase().trim();

  const filtered = UNIQUE_STOPS.filter(stop =>
    !q ||
    stop.name.toLowerCase().includes(q) ||
    stop.routes.toLowerCase().includes(q) ||
    stop.area.toLowerCase().includes(q)
  );

  const areas = {};
  filtered.forEach(stop => {
    if (!areas[stop.area]) areas[stop.area] = [];
    areas[stop.area].push(stop);
  });

  let html = '';
  for (const [area, stops] of Object.entries(areas)) {
    html += `<div class="stop-area-label">${area}</div>`;
    stops.forEach(stop => {
      const sel = cfg.ntuStop === stop.name;
      html += `<div class="stop-item ${sel ? 'selected' : ''}" onclick="selectStop('${stop.name.replace(/'/g,"\\'")}')">
        <span class="si-name">${stop.name}</span>
        <span class="si-routes">${stop.routes}</span>
        <span class="si-check">${sel ? '‚úì' : ''}</span>
      </div>`;
    });
  }

  if (!html) html = `<div style="padding:16px;text-align:center;color:var(--muted);font-size:.8rem">No stops match "${query}"</div>`;
  container.innerHTML = html;

  const disp = document.getElementById('selectedStopDisplay');
  if (disp) disp.textContent = cfg.ntuStop ? `Selected: ${cfg.ntuStop}` : '';
}

function filterStops(q) { renderStopList(q); }

function selectStop(name) {
  cfg.ntuStop = name;
  renderStopList(document.getElementById('stopSearchInput').value);
}

function saveConfig() {
  cfg.refresh = parseInt(document.getElementById('cfgRefresh').value) || 30;

  // API keys
  const ltaEl = document.getElementById('cfgLtaKey');
  if (ltaEl) cfg.ltaKey = ltaEl.value.trim();
  const wxEl = document.getElementById('cfgWeatherKey');
  if (wxEl) cfg.weatherKey = wxEl.value.trim();

  // Spotify client ID
  const spIdEl = document.getElementById('cfgSpClientId');
  if (spIdEl) cfg.spotifyClientId = spIdEl.value.trim();

  // Bus stops (from selectedStops array)
  cfg.busStops = [...selectedStops];

  // Build ntuRoutes from checkboxes
  const routes = [];
  if (document.getElementById('rt-clb').checked)  routes.push('CL-B');
  if (document.getElementById('rt-clr').checked)  routes.push('CL-R');
  if (document.getElementById('rt-cr').checked)   routes.push('CR');
  if (document.getElementById('rt-cwr').checked)  routes.push('CWR');
  cfg.ntuRoutes = routes.length ? routes.join(',') : 'CL-B,CL-R,CR';

  localStorage.setItem('smartDisplayConfig', JSON.stringify(cfg));
  closeConfig();
  startApp();
}

function openConfig() {
  document.getElementById('cfgRefresh').value = cfg.refresh || 30;

  // API keys
  const ltaEl = document.getElementById('cfgLtaKey');
  if (ltaEl) ltaEl.value = cfg.ltaKey || '';
  const wxEl = document.getElementById('cfgWeatherKey');
  if (wxEl) wxEl.value = cfg.weatherKey || '';

  // Bus stops
  selectedStops = [...(cfg.busStops || [])];
  renderSelectedChips();
  renderBusStopList();
  const bsInput = document.getElementById('busStopSearchInput');
  if (bsInput) bsInput.value = '';

  // NTU route checkboxes
  const routes = (cfg.ntuRoutes || 'CL-B,CL-R,CR').split(',').map(r => r.trim());
  document.getElementById('rt-clb').checked = routes.includes('CL-B');
  document.getElementById('rt-clr').checked = routes.includes('CL-R');
  document.getElementById('rt-cr').checked  = routes.includes('CR');
  document.getElementById('rt-cwr').checked = routes.includes('CWR');

  // NTU stop picker
  renderStopList();
  document.getElementById('stopSearchInput').value = '';

  // Spotify
  const spIdEl = document.getElementById('cfgSpClientId');
  if (spIdEl) spIdEl.value = cfg.spotifyClientId || '';
  spUpdateSettingsPanel();

  document.getElementById('configModal').classList.add('open');
  switchTab('bus');
}

function closeConfig() {
  document.getElementById('configModal').classList.remove('open');
}

document.getElementById('configModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('configModal')) closeConfig();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOCK & DATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function updateClock() {
  const now = new Date();
  const hh  = String(now.getHours()).padStart(2,'0');
  const mm  = String(now.getMinutes()).padStart(2,'0');
  const ss  = String(now.getSeconds()).padStart(2,'0');

  document.getElementById('clockHM').textContent  = `${hh}:${mm}`;
  document.getElementById('clockSec').textContent = ss;

  const day   = DAYS[now.getDay()];
  const date  = now.getDate();
  const month = MONTHS[now.getMonth()];
  const year  = now.getFullYear();

  document.getElementById('dayName').textContent   = day.toUpperCase();
  document.getElementById('dateString').textContent = `${date} ${month} ${year}`;

  updateNtuSemesterInfo(now);
}

function updateNtuSemesterInfo(now) {
  // NTU Academic Calendar estimate (adjust each year)
  // Sem 1 roughly Aug‚ÄìNov, Sem 2 roughly Jan‚ÄìApr
  const month = now.getMonth(); // 0-indexed
  const day   = now.getDate();

  let sem = '‚Äî';
  let week = '‚Äî';

  // Rough semester boundaries (2025 AY)
  const semBounds = [
    { name: 'Semester 1 AY25/26', start: new Date('2025-08-11'), end: new Date('2025-11-28') },
    { name: 'Semester 2 AY25/26', start: new Date('2026-01-12'), end: new Date('2026-04-30') },
  ];

  for (const s of semBounds) {
    if (now >= s.start && now <= s.end) {
      sem = s.name;
      const diffMs = now - s.start;
      const diffWeeks = Math.floor(diffMs / (7*24*60*60*1000)) + 1;
      week = `Week ${Math.min(diffWeeks, 13)}`;
      break;
    }
  }

  // Check vacation / exam periods
  if (sem === '‚Äî') {
    const examPeriods = [
      { label: 'üìù Exam Period', start: new Date('2025-11-21'), end: new Date('2025-12-06') },
      { label: 'üìù Exam Period', start: new Date('2026-04-24'), end: new Date('2026-05-09') },
    ];
    for (const ep of examPeriods) {
      if (now >= ep.start && now <= ep.end) { sem = ep.label; break; }
    }
  }
  if (sem === '‚Äî') sem = 'Vacation / Break';

  document.getElementById('semLabel').textContent  = sem;
  document.getElementById('weekLabel').textContent = week;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NTU OMNIBUS ‚Äî Schedule-based (no public API available)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NTU's Omnibus uses a closed Fleet Management System (OutSystems-based).
// No public API endpoint exists. We provide schedule-based timings derived
// from official NTU published timetables.
//
// Route info: https://www.ntu.edu.sg/about-us/visiting-ntu/internal-campus-shuttle

const NTU_SCHEDULES = {
  'CL-B': {
    name: 'Campus Loop ‚Äì Blue',
    color: 'clb',
    interval: 10, // minutes between buses (approximate)
    // First/last bus from main terminus (Opp Hall 11)
    weekday: { first: '08:00', last: '22:00' },
    weekend: { first: '08:00', last: '22:00' },
    active: true,
  },
  'CL-R': {
    name: 'Campus Loop ‚Äì Red',
    color: 'clr',
    interval: 10,
    weekday: { first: '08:00', last: '22:00' },
    weekend: { first: '08:00', last: '22:00' },
    active: true,
  },
  'CR': {
    name: 'Campus Rider (‚Üí Pioneer MRT)',
    color: 'cr',
    interval: 15,
    weekday: { first: '07:30', last: '23:00' },
    weekend: { first: '08:00', last: '23:00' },
    active: true,
  },
};

// Generate next departures based on schedule interval
function getNextDepartures(route, now, count = 3) {
  const r = NTU_SCHEDULES[route];
  if (!r) return [];

  const isWeekend = [0,6].includes(now.getDay());
  const sched = isWeekend ? r.weekend : r.weekday;

  const [fh, fm] = sched.first.split(':').map(Number);
  const [lh, lm] = sched.last.split(':').map(Number);

  const firstMinutes = fh * 60 + fm;
  const lastMinutes  = lh * 60 + lm;
  const nowMinutes   = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;

  if (nowMinutes > lastMinutes + r.interval) return [];
  if (nowMinutes < firstMinutes) {
    // Before first bus
    const upcoming = [];
    for (let i = 0; i < count; i++) {
      upcoming.push(firstMinutes + i * r.interval);
    }
    return upcoming.map(m => {
      const h = Math.floor(m / 60) % 24;
      const min = m % 60;
      return { time: `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}`, mins: Math.round(m - nowMinutes) };
    });
  }

  // During service hours ‚Äî find next departure slot
  const elapsed = nowMinutes - firstMinutes;
  const slotsElapsed = Math.floor(elapsed / r.interval);
  const nextSlotMins = firstMinutes + (slotsElapsed + 1) * r.interval;

  const upcoming = [];
  for (let i = 0; i < count; i++) {
    const slotMins = nextSlotMins + i * r.interval;
    if (slotMins > lastMinutes + r.interval) break;
    const h   = Math.floor(slotMins / 60) % 24;
    const min = slotMins % 60;
    upcoming.push({
      time: `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}`,
      mins: Math.round(slotMins - nowMinutes)
    });
  }
  return upcoming;
}

function fetchNtuBus() {
  const routes = cfg.ntuRoutes.split(',').map(r => r.trim().toUpperCase()).filter(Boolean);
  const now    = new Date();
  const stopLabel = cfg.ntuStop || 'Campus';
  let html = '';

  html += `<div style="margin-bottom:12px">
    <span style="font-family:var(--font-display);font-size:.95rem">Stop:</span>
    <span class="stop-code">${stopLabel}</span>
  </div>`;

  html += `<div class="ntu-notice" style="margin-bottom:14px">
    <strong>‚ÑπÔ∏è Schedule-based</strong> ‚Äî NTU Omnibus has no public API.
    These timings are estimated from the official schedule (¬±2‚Äì3 min offset).
    For real-time data, use the <strong>NTU Omnibus app</strong>.
  </div>`;

  for (const route of routes) {
    const info = NTU_SCHEDULES[route];
    if (!info) continue;

    const departures = getNextDepartures(route, now);

    html += `<div class="ntu-arrival-row">
      <div class="ntu-route-info">
        <span class="ntu-route-badge ${info.color}">${route}</span>
        <span class="ntu-route-name">${info.name}</span>
      </div>
      <div class="ntu-times">`;

    if (departures.length === 0) {
      html += `<span class="ntu-time-chip" style="color:var(--muted)">Not in service</span>`;
    } else {
      departures.forEach((dep, i) => {
        const cls = i === 0 ? (dep.mins <= 2 ? 'next' : 'soon') : '';
        const label = dep.mins <= 1 ? 'Arr' : `${dep.mins}m`;
        html += `<span class="ntu-time-chip ${cls}" title="${dep.time}">${label}</span>`;
      });
    }

    html += `</div></div>`;
  }

  if (routes.length === 0) {
    html += `<div class="error-msg">No routes configured. Click ‚öô Settings and set NTU Routes.</div>`;
  }

  document.getElementById('ntuBusContent').innerHTML = html;
  document.getElementById('ntuStatusDot').className = 'status-dot status-live';
  document.getElementById('ntuLastUpdated').textContent =
    'Est. at ' + now.toLocaleTimeString('en-SG',{hour:'2-digit',minute:'2-digit'});
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPOTIFY ‚Äî PKCE Auth + Now Playing
// No backend required. PKCE flow runs entirely in
// the browser. User creates a free Spotify app at
// developer.spotify.com and pastes the Client ID.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const SP_SCOPES      = 'user-read-currently-playing user-read-playback-state';
const SP_API_BASE    = 'https://api.spotify.com/v1';
const SP_AUTH_URL    = 'https://accounts.spotify.com/authorize';
const SP_TOKEN_URL   = 'https://accounts.spotify.com/api/token';

// Polling: 5s while playing, 30s while paused/idle
let spPollInterval  = null;
let spProgressTimer = null;
let spCurrentMs     = 0;   // local progress counter
let spDurationMs    = 0;
let spIsPlaying     = false;

// ‚îÄ‚îÄ‚îÄ PKCE helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spRedirectUri() {
  // Must match exactly what's in the Spotify Developer Dashboard.
  // GitHub Pages serves this at the directory URL (no filename).
  return 'https://chenfenggoh.github.io/display/';
}

async function pkceChallenge() {
  const verifier = Array.from(crypto.getRandomValues(new Uint8Array(64)))
    .map(b => 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~'[b % 66])
    .join('');
  const data   = new TextEncoder().encode(verifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  const challenge = btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return { verifier, challenge };
}

// ‚îÄ‚îÄ‚îÄ Auth flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function spotifyLogin() {
  const clientId = cfg.spotifyClientId;
  if (!clientId) {
    alert('Please enter your Spotify Client ID in ‚öô Settings ‚Üí Spotify first.');
    openConfig(); switchTab('spotify'); return;
  }
  const { verifier, challenge } = await pkceChallenge();
  localStorage.setItem('sp_verifier', verifier);
  localStorage.setItem('sp_client_id', clientId);

  const params = new URLSearchParams({
    client_id:             clientId,
    response_type:         'code',
    redirect_uri:          spRedirectUri(),
    scope:                 SP_SCOPES,
    code_challenge_method: 'S256',
    code_challenge:        challenge,
    state:                 'ntu_display',
  });
  window.location.href = SP_AUTH_URL + '?' + params;
}

async function spotifyLoginFromSettings() {
  // Save the client ID from settings before redirecting
  const id = document.getElementById('cfgSpClientId').value.trim();
  if (!id) { alert('Please enter your Spotify Client ID.'); return; }
  cfg.spotifyClientId = id;
  localStorage.setItem('smartDisplayConfig', JSON.stringify(cfg));
  await spotifyLogin();
}

async function spHandleCallback() {
  const params   = new URLSearchParams(window.location.search);
  const code     = params.get('code');
  const state    = params.get('state');
  if (!code || state !== 'ntu_display') return;

  // Clean up URL
  window.history.replaceState({}, '', window.location.pathname);

  const verifier  = localStorage.getItem('sp_verifier');
  const clientId  = localStorage.getItem('sp_client_id') || cfg.spotifyClientId;
  if (!verifier || !clientId) return;

  try {
    const res = await fetch(SP_TOKEN_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type:    'authorization_code',
        code,
        redirect_uri:  spRedirectUri(),
        client_id:     clientId,
        code_verifier: verifier,
      }),
    });
    if (!res.ok) {
      const errBody = await res.json().catch(() => ({}));
      const detail = errBody.error_description || errBody.error || res.status;
      throw new Error(`${detail} (redirect_uri used: ${spRedirectUri()})`);
    }
    const data = await res.json();
    spSaveTokens(data, clientId);
    localStorage.removeItem('sp_verifier');
  } catch (e) {
    console.error('Spotify token exchange error:', e);
    spRenderIdle(`Auth failed: ${e.message}`);
  }
}

function spSaveTokens(data, clientId) {
  const expiry = Date.now() + data.expires_in * 1000;
  localStorage.setItem('sp_access_token',  data.access_token);
  localStorage.setItem('sp_refresh_token', data.refresh_token);
  localStorage.setItem('sp_token_expiry',  expiry);
  localStorage.setItem('sp_client_id',     clientId || cfg.spotifyClientId);
  cfg.spotifyClientId = clientId || cfg.spotifyClientId;
  localStorage.setItem('smartDisplayConfig', JSON.stringify(cfg));
  spStartPolling();
}

async function spRefreshToken() {
  const refreshToken = localStorage.getItem('sp_refresh_token');
  const clientId     = localStorage.getItem('sp_client_id') || cfg.spotifyClientId;
  if (!refreshToken || !clientId) throw new Error('No refresh token');

  const res = await fetch(SP_TOKEN_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type:    'refresh_token',
      refresh_token: refreshToken,
      client_id:     clientId,
    }),
  });
  if (!res.ok) throw new Error(`Refresh failed: ${res.status}`);
  const data = await res.json();
  const expiry = Date.now() + data.expires_in * 1000;
  localStorage.setItem('sp_access_token', data.access_token);
  localStorage.setItem('sp_token_expiry', expiry);
  if (data.refresh_token) localStorage.setItem('sp_refresh_token', data.refresh_token);
  return data.access_token;
}

async function spGetToken() {
  const token  = localStorage.getItem('sp_access_token');
  const expiry = parseInt(localStorage.getItem('sp_token_expiry') || '0');
  if (!token) return null;
  if (Date.now() > expiry - 60000) return await spRefreshToken();
  return token;
}

function spotifyLogout() {
  localStorage.removeItem('sp_access_token');
  localStorage.removeItem('sp_refresh_token');
  localStorage.removeItem('sp_token_expiry');
  clearInterval(spPollInterval);
  clearInterval(spProgressTimer);
  spRenderIdle('Disconnected');
  spUpdateSettingsPanel();
}

// ‚îÄ‚îÄ‚îÄ Now Playing fetch & render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchNowPlaying() {
  const token = await spGetToken().catch(() => null);
  if (!token) {
    spRenderConnectPrompt();
    return;
  }

  try {
    const res = await fetch(`${SP_API_BASE}/me/player/currently-playing`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (res.status === 204 || res.status === 200 && res.headers.get('content-length') === '0') {
      spRenderNothing();
      spSetPollRate(false);
      return;
    }
    if (!res.ok) {
      if (res.status === 401) { await spRefreshToken(); fetchNowPlaying(); return; }
      throw new Error(`Spotify API ${res.status}`);
    }

    const data = await res.json();
    if (!data || !data.item) { spRenderNothing(); spSetPollRate(false); return; }

    spIsPlaying  = data.is_playing;
    spCurrentMs  = data.progress_ms || 0;
    spDurationMs = data.item.duration_ms || 0;

    spRenderTrack(data);
    spSetPollRate(data.is_playing);

    // Local progress ticker while playing
    clearInterval(spProgressTimer);
    if (data.is_playing) {
      spProgressTimer = setInterval(() => {
        spCurrentMs = Math.min(spCurrentMs + 1000, spDurationMs);
        spUpdateProgress();
      }, 1000);
    }

  } catch (e) {
    console.warn('Spotify fetch error:', e.message);
  }
}

function spSetPollRate(playing) {
  clearInterval(spPollInterval);
  spPollInterval = setInterval(fetchNowPlaying, playing ? 5000 : 30000);
}

function spStartPolling() {
  fetchNowPlaying();
  spUpdateSettingsPanel();
}

// ‚îÄ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spFmtTime(ms) {
  if (!ms) return '0:00';
  const s = Math.floor(ms / 1000);
  return `${Math.floor(s / 60)}:${String(s % 60).padStart(2,'0')}`;
}

function spRenderConnectPrompt() {
  document.getElementById('spotifyCard').innerHTML = `
    <div class="sp-idle">
      <div class="sp-idle-icon">üéµ</div>
      <div class="sp-idle-text">Connect Spotify to see what's playing</div>
      <button class="sp-connect-btn" onclick="spotifyLogin()">‚ô´ Connect Spotify</button>
    </div>`;
  document.getElementById('spHeaderBtn').innerHTML = '';
}

function spRenderIdle(msg = '') {
  document.getElementById('spotifyCard').innerHTML = `
    <div class="sp-idle">
      <div class="sp-idle-icon">üéµ</div>
      <div class="sp-idle-text">${msg || 'Connect Spotify to see what\'s playing'}</div>
      <button class="sp-connect-btn" onclick="spotifyLogin()">‚ô´ Connect Spotify</button>
    </div>`;
  document.getElementById('spHeaderBtn').innerHTML = '';
}

function spRenderNothing() {
  clearInterval(spProgressTimer);
  document.getElementById('spotifyCard').innerHTML = `
    <div class="sp-nothing">Nothing playing right now</div>`;
  document.getElementById('spHeaderBtn').innerHTML =
    `<button class="sp-disconnect-btn" onclick="spotifyLogout()">Disconnect</button>`;
}

function spRenderTrack(data) {
  const track  = data.item;
  const art    = track.album?.images?.[0]?.url || '';
  const name   = track.name || '‚Äî';
  const artist = track.artists?.map(a => a.name).join(', ') || '‚Äî';
  const album  = track.album?.name || '';
  const pct    = spDurationMs ? Math.round((spCurrentMs / spDurationMs) * 100) : 0;

  document.getElementById('spotifyCard').innerHTML = `
    <div class="sp-now-playing">
      ${art ? `<img class="sp-album-art ${data.is_playing ? 'spinning' : ''}" src="${art}" alt="Album art" id="spAlbumArt">` :
               `<div class="sp-album-art" style="display:flex;align-items:center;justify-content:center;font-size:2rem">üéµ</div>`}
      <div class="sp-track-info">
        <div class="sp-track-name" title="${name}">${name}</div>
        <div class="sp-artist">${artist}</div>
        <div class="sp-album">${album}</div>
        <div class="sp-progress-wrap">
          <div class="sp-progress-bar">
            <div class="sp-progress-fill" id="spProgressFill" style="width:${pct}%"></div>
          </div>
          <div class="sp-times">
            <span id="spCurrentTime">${spFmtTime(spCurrentMs)}</span>
            <span>${spFmtTime(spDurationMs)}</span>
          </div>
        </div>
        <div class="sp-state-row">
          ${data.is_playing
            ? `<span class="sp-playing-badge">PLAYING</span>`
            : `<span class="sp-paused-badge">‚è∏ PAUSED</span>`}
        </div>
      </div>
    </div>`;

  document.getElementById('spHeaderBtn').innerHTML =
    `<button class="sp-disconnect-btn" onclick="spotifyLogout()">Disconnect</button>`;
}

function spUpdateProgress() {
  const fill = document.getElementById('spProgressFill');
  const time = document.getElementById('spCurrentTime');
  if (fill && spDurationMs) {
    fill.style.width = Math.min(100, (spCurrentMs / spDurationMs) * 100) + '%';
  }
  if (time) time.textContent = spFmtTime(spCurrentMs);
}

// ‚îÄ‚îÄ‚îÄ Settings panel sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spUpdateSettingsPanel() {
  const connected     = !!localStorage.getItem('sp_access_token');
  const connectBtn    = document.getElementById('spSettingsConnectBtn');
  const disconnectBtn = document.getElementById('spSettingsDisconnectBtn');
  const status        = document.getElementById('spSettingsStatus');
  if (!connectBtn) return;

  if (connected) {
    connectBtn.style.display    = 'none';
    disconnectBtn.style.display = '';
    if (status) status.innerHTML = `<div style="color:#1db954;font-size:.8rem">‚úì Connected to Spotify</div>`;
  } else {
    connectBtn.style.display    = '';
    disconnectBtn.style.display = 'none';
    if (status) status.innerHTML = `<div style="color:var(--muted);font-size:.8rem">Not connected</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ Init: check for OAuth callback or existing token ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function spInit() {
  // Pre-fill client ID if saved
  const clientIdInput = document.getElementById('cfgSpClientId');
  if (clientIdInput && cfg.spotifyClientId) clientIdInput.value = cfg.spotifyClientId;

  // Handle OAuth callback (code= in URL query string)
  if (window.location.search.includes('code=')) {
    document.getElementById('spotifyCard').innerHTML = `
      <div class="sp-idle">
        <div class="sp-idle-icon">üéµ</div>
        <div class="sp-idle-text">Connecting to Spotify‚Ä¶</div>
      </div>`;
    await spHandleCallback();
    spUpdateSettingsPanel();
    return;
  }

  // Resume from saved token
  const token = await spGetToken().catch(() => null);
  if (token) {
    spStartPolling();
  } else {
    spRenderConnectPrompt();
  }

  spUpdateSettingsPanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEATHER ‚Äî NEA data.gov.sg (primary) + OWM fallback
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WEATHER_ICON = {
  'Fair':'‚òÄÔ∏è','Fair (Day)':'‚òÄÔ∏è','Fair (Night)':'üåô',
  'Fair & Warm':'üå§Ô∏è','Partly Cloudy':'‚õÖ','Partly Cloudy (Day)':'‚õÖ','Partly Cloudy (Night)':'üå•Ô∏è',
  'Cloudy':'‚òÅÔ∏è','Hazy':'üå´Ô∏è','Slightly Hazy':'üå´Ô∏è',
  'Windy':'üí®','Mist':'üå´Ô∏è','Fog':'üå´Ô∏è',
  'Light Rain':'üå¶Ô∏è','Moderate Rain':'üåßÔ∏è','Heavy Rain':'üåßÔ∏è',
  'Passing Showers':'üå¶Ô∏è','Light Showers':'üå¶Ô∏è','Showers':'üåßÔ∏è','Heavy Showers':'üåßÔ∏è',
  'Thundery Showers':'‚õàÔ∏è','Heavy Thundery Showers':'‚õàÔ∏è',
  'Heavy Thundery Showers with Gusty Winds':'‚õàÔ∏è',
};
function wxIcon(desc) {
  return WEATHER_ICON[desc] || (desc.includes('Thunder') ? '‚õàÔ∏è' : desc.includes('Rain') ? 'üåßÔ∏è' : '‚õÖ');
}
function wxWindDir(deg) {
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg / 22.5) % 16];
}
function wxHeatIndex(tempC, rh) {
  const T = tempC * 9/5 + 32, R = rh;
  let hi = -42.379 + 2.04901523*T + 10.14333127*R - 0.22475541*T*R
    - 0.00683783*T*T - 0.05481717*R*R + 0.00122874*T*T*R
    + 0.00085282*T*R*R - 0.00000199*T*T*R*R;
  return ((hi - 32) * 5/9).toFixed(1);
}

async function fetchWeatherNEA() {
  const BASE = 'https://api.data.gov.sg/v1/environment';
  const [tempR, humR, windR, fcR] = await Promise.all([
    fetch(`${BASE}/air-temperature`),
    fetch(`${BASE}/relative-humidity`),
    fetch(`${BASE}/wind-speed`),
    fetch(`${BASE}/24-hour-weather-forecast`),
  ]);
  const [tempD, humD, windD, fcD] = await Promise.all([
    tempR.json(), humR.json(), windR.json(), fcR.json()
  ]);

  // Find nearest reading to NTU (Jurong West area)
  const pickNearest = (readings, lat=1.3483, lon=103.6831) => {
    if (!readings?.length) return null;
    return readings.reduce((best, r) => {
      if (!r.location) return best;
      const d = Math.hypot(r.location.latitude - lat, r.location.longitude - lon);
      return (!best || d < best.d) ? { ...r, d } : best;
    }, null);
  };

  const tempReading = pickNearest(tempD.items?.[0]?.readings);
  const humReading  = pickNearest(humD.items?.[0]?.readings);
  const windReading = pickNearest(windD.items?.[0]?.readings);
  const fc          = fcD.items?.[0]?.general;

  const temp = tempReading?.value ?? '‚Äî';
  const hum  = humReading?.value  ?? '‚Äî';
  const wind = windReading?.value ?? '‚Äî';
  const desc = fc?.forecast ?? 'No forecast';
  const hi   = (typeof temp === 'number' && typeof hum === 'number')
               ? wxHeatIndex(temp, hum) : null;

  renderWeather({ temp, hum, wind, desc, hi, source: 'NEA' });
}

async function fetchWeatherOWM(apiKey) {
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=1.3483&lon=103.6831&appid=${apiKey}&units=metric`;
  const res  = await fetch(url);
  if (!res.ok) throw new Error(`OWM ${res.status}`);
  const d    = await res.json();
  const temp = d.main.temp.toFixed(1);
  const hum  = d.main.humidity;
  const wind = (d.wind.speed * 3.6).toFixed(1); // m/s ‚Üí km/h
  const desc = d.weather[0].description.replace(/\b\w/g, c => c.toUpperCase());
  const hi   = wxHeatIndex(parseFloat(temp), hum);
  renderWeather({ temp, hum, wind, desc, hi, source: 'OWM', windKmh: true });
}

function renderWeather({ temp, hum, wind, desc, hi, source, windKmh }) {
  const el = document.getElementById('weatherContent');
  if (!el) return;
  const icon    = wxIcon(desc);
  const windStr = windKmh ? `${wind} km/h` : `${wind} km/h`;
  el.innerHTML = `
    <div class="weather-main">
      <div class="weather-icon">${icon}</div>
      <div>
        <div class="weather-temp">${temp}<span class="weather-unit">¬∞C</span></div>
        <div class="weather-desc">${desc}</div>
      </div>
    </div>
    <div class="weather-details">
      <div class="weather-detail">
        <div class="wlabel">Humidity</div>
        <div class="wval">${hum}%</div>
      </div>
      <div class="weather-detail">
        <div class="wlabel">Wind</div>
        <div class="wval">${windStr}</div>
      </div>
      ${hi ? `<div class="weather-detail">
        <div class="wlabel">Heat Index</div>
        <div class="wval">${hi}¬∞C</div>
      </div>` : ''}
      <div class="weather-detail">
        <div class="wlabel">Location</div>
        <div class="wval" style="font-size:.7rem">Jurong West</div>
      </div>
    </div>`;
}

async function fetchWeather() {
  try {
    await fetchWeatherNEA();
  } catch (e) {
    console.warn('NEA weather failed:', e.message);
    if (cfg.weatherKey) {
      try { await fetchWeatherOWM(cfg.weatherKey); return; } catch(e2) { console.warn('OWM fallback failed:', e2.message); }
    }
    const el = document.getElementById('weatherContent');
    if (el) el.innerHTML = `<div class="loading-text" style="color:var(--muted)">Weather unavailable</div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PUBLIC BUS ‚Äî arrivelah (busrouter.sg) proxy for LTA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ltaRefreshInterval = null;

function fmtArrival(mins) {
  if (mins <= 0)  return { text: 'Arr', cls: 'arriving' };
  if (mins === 1) return { text: '1 min', cls: 'arriving' };
  return { text: `${mins} min`, cls: mins <= 3 ? 'next' : '' };
}
function loadClass(load) {
  if (!load) return '';
  if (load === 'SEA') return 'pb-load-full';
  if (load === 'SDA') return 'pb-load-stand';
  return 'pb-load-seat';
}
function loadLabel(load) {
  if (load === 'SEA') return 'üî¥';
  if (load === 'SDA') return 'üü°';
  if (load === 'LSD') return 'üü¢';
  return '';
}

async function fetchBusStop(stopCode) {
  const url = `https://arrivelah2.busrouter.sg/?id=${stopCode}`;
  const res  = await fetch(url);
  if (!res.ok) throw new Error(`arrivelah ${res.status}`);
  return res.json();
}

async function fetchLtaBus() {
  const stops = cfg.busStops || [];
  const el    = document.getElementById('ltaBusContent');
  const dot   = document.getElementById('ltaStatusDot');
  const upd   = document.getElementById('ltaLastUpdated');

  if (!stops.length) {
    if (el) el.innerHTML = `<div class="loading-text">Select bus stops in ‚öô Settings ‚Üí Bus Stops</div>`;
    if (dot) dot.className = 'status-dot status-offline';
    return;
  }

  if (el) el.innerHTML = `<div class="loading-text">Loading bus arrivals‚Ä¶</div>`;

  try {
    const results = await Promise.all(stops.map(code => fetchBusStop(code)));

    let html = '<div class="public-bus-grid">';
    results.forEach((data, i) => {
      const code     = stops[i];
      const stopInfo = PUBLIC_BUS_MAP[code];
      const name     = stopInfo ? stopInfo.name : `Stop ${code}`;
      const services = data.services || [];

      html += `<div class="pb-stop-block">
        <div class="pb-stop-name">üöè ${name} <span style="opacity:.5">(${code})</span></div>
        <div class="pb-services">`;

      if (!services.length) {
        html += `<div style="color:var(--muted);font-size:.75rem;padding:4px 0">No services available</div>`;
      } else {
        services.forEach(svc => {
          const next = svc.next;
          const sub  = svc.subsequent;
          const arr1 = fmtArrival(next?.duration_ms != null ? Math.round(next.duration_ms / 60000) : 99);
          const arr2 = sub?.duration_ms != null ? fmtArrival(Math.round(sub.duration_ms / 60000)) : null;
          html += `<div class="pb-svc">
            <span class="pb-svc-no">${svc.no}</span>
            <div class="pb-times">
              <span class="pb-time next ${arr1.cls} ${loadClass(next?.load)}">${loadLabel(next?.load)} ${arr1.text}</span>
              ${arr2 ? `<span class="pb-time ${arr2.cls} ${loadClass(sub?.load)}">${loadLabel(sub?.load)} ${arr2.text}</span>` : ''}
            </div>
          </div>`;
        });
      }
      html += `</div></div>`;
    });
    html += '</div>';

    if (el) el.innerHTML = html;
    if (dot) dot.className = 'status-dot status-online';
    if (upd) upd.textContent = 'Updated ' + new Date().toLocaleTimeString('en-SG', { hour: '2-digit', minute: '2-digit' });

  } catch (e) {
    console.warn('LTA bus fetch error:', e.message);
    if (el) el.innerHTML = `<div class="loading-text" style="color:var(--muted)">Bus data unavailable ‚Äî check connection</div>`;
    if (dot) dot.className = 'status-dot status-offline';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT & REFRESH LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startApp() {
  if (clockInterval)    clearInterval(clockInterval);
  if (refreshInterval)  clearInterval(refreshInterval);
  if (ltaRefreshInterval) clearInterval(ltaRefreshInterval);

  updateClock();
  clockInterval = setInterval(updateClock, 1000);

  // NTU shuttle ‚Äî refresh every cfg.refresh seconds
  fetchNtuBus();
  const interval = Math.max(15, cfg.refresh) * 1000;
  refreshInterval = setInterval(fetchNtuBus, interval);

  // Weather ‚Äî refresh every 10 minutes
  fetchWeather();
  setInterval(fetchWeather, 10 * 60 * 1000);

  // Public bus ‚Äî refresh every 30 seconds
  fetchLtaBus();
  ltaRefreshInterval = setInterval(fetchLtaBus, 30 * 1000);
}

// ‚îÄ‚îÄ First boot ‚îÄ‚îÄ
window.addEventListener('load', () => {
  startApp();
  spInit();
});
</script>
</body>
</html>
